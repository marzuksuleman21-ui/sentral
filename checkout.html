<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1 style="text-align:center; margin-top:20px;">Checkout</h1>

  <div id="checkoutList" class="checkout-container"></div>

  <div style="padding:20px;">
    <button class="pay-btn" id="btnPay">Bayar & Simpan Pesanan</button>
    <button class="pay-btn" id="btnWA" style="background:#0ea5e9;">Kirim WhatsApp</button>
    <button class="pay-btn" id="btnPDF" style="background:#6d28d9;">Cetak Struk PDF</button>
  </div>

<script type="module">
// FIREBASE
import { db } from "./firebase-config.js";
import {
  collection, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let ordersRef = collection(db, "orders");

// CART
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// RENDER CHECKOUT
function renderCheckout() {
  let box = document.getElementById("checkoutList");

  if (cart.length === 0) {
    box.innerHTML = `<p style="text-align:center; padding:20px;">Keranjang kosong.</p>`;
    return;
  }

  let total = 0;

  box.innerHTML = cart.map((item, i) => {
    let subtotal = item.price * item.qty;
    total += subtotal;
    return `
      <div class="checkout-item">
        <img src="${item.photo}" class="checkout-img">
        <div class="info">
          <h3>${item.name}</h3>
          <p>Harga: Rp ${item.price}</p>

          <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
            <button class="qty-btn" onclick="changeQty(${i}, -1)">−</button>
            <span>${item.qty}</span>
            <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
          </div>

          <p>Subtotal: Rp ${subtotal}</p>
        </div>

        <button class="delete-btn" onclick="removeItem(${i})">X</button>
      </div>
    `;
  }).join("");

  box.innerHTML += `
    <hr>
    <h2>Total Pembayaran: Rp ${total}</h2>
  `;

  return total;
}

// UBAH QTY
window.changeQty = (index, val) => {
  cart[index].qty += val;
  if (cart[index].qty < 1) cart[index].qty = 1;
  saveCart();
};

// HAPUS ITEM
window.removeItem = index => {
  cart.splice(index, 1);
  saveCart();
};

// SIMPAN CART
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCheckout();
}

// SIMPAN ORDER KE FIREBASE
async function saveOrder() {
  let total = renderCheckout();

  const order = {
    items: cart,
    total: total,
    time: serverTimestamp()
  };

  await addDoc(ordersRef, order);
  alert("Pesanan disimpan ke Firebase!");

  localStorage.removeItem("cart");
  window.location.href = "index.html";
}

// KIRIM WHATSAPP
function sendWhatsApp() {
  let text = "*Pesanan Baru:*\n\n";
  cart.forEach(item => {
    text += `• ${item.name} x${item.qty} = Rp ${item.price * item.qty}\n`;
  });
  text += `\nTotal: Rp ${renderCheckout()}`;

  let url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

// CETAK PDF
function printPDF() {
  let printContent = document.getElementById("checkoutList").innerHTML;
  let w = window.open("");
  w.document.write("<html><head><title>Struk Pembayaran</title></head><body>");
  w.document.write(printContent);
  w.document.write("</body></html>");
  w.document.close();
  w.print();
}

// EVENT BUTTONS
document.getElementById("btnPay").onclick = saveOrder;
document.getElementById("btnWA").onclick = sendWhatsApp;
document.getElementById("btnPDF").onclick = printPDF;

// RUN
renderCheckout();

</script>

<style>
.qty-btn {
  padding: 4px 10px;
  border: none;
  background: #059669;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

.delete-btn {
  background: #dc2626;
  color: white;
  border: none;
  padding: 6px 10px;
  height: fit-content;
  border-radius: 6px;
  cursor: pointer;
}
</style>

</body>
</html>
